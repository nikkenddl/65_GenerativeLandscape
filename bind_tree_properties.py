data_species_property = """＜常緑針葉樹＞										
アカマツ				30m	×	△	A	A	速	
AM1	8.0	0.80	3.5							
AM2	5.0	株立	2.0							
カヤ				20m	〇	〇	A	A	遅	
CY	8.0	0.60	3.5							
モミ				20m	〇	〇	A	A	速	
MM	8.0	0.60	3.5							
＜常緑広葉樹＞										
ホルトノキ				10m	×	○	C	C	遅	
HT	8.0	0.60	4.0							
アラカシ				20m	○	△	B	C	速	
AK1	8.0	株立	3.5							
AK2	5.0	株立	2.0							
AK3	3.0	株立	1.2							
シラカシ				20m	○	〇	B	C	速	
SK1	10.0	株立	4.0							
SK2	8.0	株立	3.5							
SK3	5.0	株立	2.0							
SK4	3.0	株立	1.2							
シロダモ				10m	△	△	B	C	速	耐風：乾寒風に対する耐性
SD1	8.0	株立	3.5							
SD2	5.0	株立	2.0							
SD3	3.0	株立	1.2							
スダジイ				25m	○	×	B	A	速	
SJ1	8.0	0.85	3.5							
SJ2	5.0	0.40	2.0							
タブノキ				20m	○	〇	B	C	速	
TB1	10.0	0.90	4.0							
TB2	8.0	0.85	3.5							
モッコク				10m	○	△	B	B	遅	
MK1	8.0	0.60	3.5							
MK2	5.0	0.40	2.0							
カクレミノ				5m	◎	○	B	A	遅	
KM1	4.0	株立	2.0							
KM2	2.0	株立	1.0							
ネズミモチ				5m	△	〇	B	B	速	
NM1	5.0	株立	2.0							
NM2	2.0	株立	1.0							
モチノキ				10m	○	〇	B	B	遅	
MC1	5.0	株立	2.0							
MC2	2.0	株立	1.0							
ヤブツバキ				10m	◎	△	B	B	遅	
YT1	5.0	株立	2.0							
YT2	2.0	株立	1.0							
ヤブニッケイ				10m	○	〇	B	C	速	
YN1	5.0	株立	2.0							
YN2	2.0	株立	1.0							
ユズリハ				10m	○	○	B	B	遅	
YH	5.0	株立	2.0							
ソヨゴ				10m	○	○	B	B	速	
SO1	4.0	株立	2.0							
SO2	2.0	株立	1.0							
ハイノキ				10m	○	○	B	C	遅	耐風：乾寒風に対する耐性
HI	3.0	株立	1.5							
ヤツデ				3m	◎	△	D	C	速	
YD	2.0	株立	1.0							
アセビ				3m	◎	〇	B	B	遅	
AB	2.0	株立	1.2							
ナンテン				3m	△	△	B	C	遅	耐風：乾寒風に対する耐性
NA	2.0	株立	1.0							
マサキ				3m	△	〇	C	C	速	
MA	2.0	株立	1.0							
＜落葉広葉樹＞										
ケヤキ				20m	×	〇	D	B	速	
KY-LL	12.0	株立	5.5							
KY-L1	8.0	株立	4.0							
KY-L2	8.0	0.70	4.0							
KY1	6.0	株立	2.5							
KY2	6.0	0.35	2.5							
ヤマザクラ				10m	×	〇	D	C	速	
YZ-L1	8.0	株立	4.0							
YZ-L2	8.0	0.70	4.0							
YZ1	6.0	株立	2.5							
YZ2	6.0	0.35	2.5							
ウワミズザクラ				10m	△	〇	D	C	速	
UZ1	7.0	株立	3.5							
UZ2	4.0	株立	2.0							
イヌザクラ				10m	△	〇	D	C	速	
IZ	5.0	株立	2.5							
カスミザクラ				10m	×	〇	D	C	速	
KZ	5.0	株立	2.5							
エノキ				15m	×	〇	D	B	速	
EK1	8.0	株立	3.5							
EK2	5.0	株立	2.0							
EK3	3.0	株立	1.2							
コナラ				15m	×	〇	B	A	速	
KR1	8.0	株立	3.5							
KR2	5.0	株立	2.5							
KR3	3.0	株立	1.2							
クヌギ				10m	×	○	B	A	速	耐風：乾寒風に対する耐性
KG1	8.0	株立	3.5							
KG2	5.0	株立	2.5							
コブシ				10m	△	×	B	C	速	
KS1	8.0	株立	3.5							
KS2	5.0	株立	2.5							
KS3	3.0	株立	1.5							
アオハダ				10m	△	○	D	B	遅	耐風：乾寒風に対する耐性
AH1	8.0	株立	3.0							
AH2	5.0	株立	2.0							
AH3	3.0	株立	1.0							
カツラ				20m	×	×	A	A	速	
KT1	8.0	株立	3.5							
KT2	5.0	株立	2.5							
KT3	3.0	株立	1.5							
アオダモ				10m	×	○	B	B	遅	耐風：乾寒風に対する耐性
AD１	8.0	株立	3.0							
AD２	5.0	株立	2.0							
AD３	3.0	株立	1.0							
アカシデ				10m	×	○	B	B	速	耐風：乾寒風に対する耐性
AS1	8.0	株立	4.0							
AS2	5.0	株立	2.5							
AS3	3.0	株立	1.5							
ミズキ				20m	×	△	D	B	速	耐風：乾寒風に対する耐性
MZ	8.0	株立	3.5							
イヌシデ				10m	×	△	B	B	速	
IS1	8.0	株立	3.5							
IS2	5.0	株立	2.0							
IS3	3.0	株立	1.0							
イロハモミジ				10m	△	×	B	B	速	
IM1	8.0	株立	4.5							
IM2	5.0	株立	2.5							
IM3	3.0	株立	1.5							
エゴノキ				10m	△	△	B	B	速	
EG1	7.0	株立	3.0							
EG2	5.0	株立	2.5							
EG3	3.0	株立	1.5							
ヤマボウシ				10m	△	〇	D	B	中	
YB1	8.0	株立	3.5							
YB2	5.0	株立	2.5							
YB3	3.0	株立	1.5							
ホオノキ				15m	△	○	B	C	速	耐風：乾寒風に対する耐性
HO	8.0	株立	3.5							
サルスベリ				10m	×	○	B	C	速	
SA	5.5	株立	3.5							
ハンノキ				15m	×	○	A	B	速	
HK1	5.0	株立	2.0							
HK2	3.0	株立	1.0							
ミツバツツジ				3m	△	△	B	B	中	
MT	3.0	株立	1.5							
ヤマツツジ				3m	△	△	B	B	中	
YJ	2.0	株立	1.2							
ウグイスカグラ				3m	△	○	B	B	中	耐風：乾寒風に対する耐性
UK	2.0	株立	1.0							
オトコヨウゾメ				3m	△	×	B	B	遅	耐風：乾燥が苦手
OY	2.0	株立	1.0							根の成長：樹高低いため浅根型
クロモジ				3m	△	×	B	C	中	
KJ	2.0	株立	1.0							
ツリバナ				6m	△	×	B	B	速	耐風：乾燥が苦手　耐陰性：○～△
TR	2.0	株立	1.5							根の成長：樹高低いため浅根型
ヤブデマリ				5m	△	×	D	C	速	耐風：乾燥が苦手　耐陰性：○～△
YD	2.0	株立	1.2							
ダンコウバイ				5m	△	△	D	B	遅	耐風：乾寒風に対する耐性
DB	2.0	株立	1.0							
ニシキギ				3m	△	△	D	C	速	
NG	2.0	株立	1.2							
マユミ				5m	×	○	B	C	速	耐風：乾寒風に対する耐性
MY	2.0	株立	1.0							
ガマズミ				3m	×	△	D	C	中	
GZ	2.0	株立	1.2							
サンショウ				5m	△	△	D	B	遅	耐陰性：○～△
SS	2.0	株立	1.0							
リョウブ				5m	×	×	B	B	速	
RB	2.0	株立	1.0							
ライラック				3m	△	○	D	B	速	耐風：乾寒風に対する耐性
RR	2.0	株立	1.2							根の成長：樹高低いため浅根型
"""

from pprint import pprint
from pathlib import Path
import re

EVERGREEN_TEXT = "常緑"
DICIDOUS_TEXT = "落葉"
BROADLEAF_TEXT = "広葉"
CONIFERS_TEXT = "針葉"

# SPECIES ROWS
SPECIES_INDEX = 0
MAXHEIGHT_INDEX = 4
SHADETOLERANCE_INDEX = 5
WINDTOLERANCE_INDEX = 6
SHAPETYPE_INDEX = 7
ROOTTYPE_INDEX = 8
GROWING_SPEED_INDEX = 9
SUPPLEMENT_INDEX = 10

# HEIGHT CATEGORY ROWS
SYMBOL_INDEX = 0
HEIGHT_INDEX = 1
TRUNK_INDEX = 2
CANOPYD_INDEX = 3

PARAM_DICT = {
    "×":0,
    "△":1,
    "○":2,
    "〇":2,
    "◎":3
}


def get_element_by_index(slicable,index,default_value=None):
    try:
        return slicable[index]
    except:
        return default_value

def extract_int(s: str, default: int = 0) -> int:
    """
    文字列から数字だけを抜き出してintに変換する関数。
    変換できない場合はdefaultの値を返す。

    Args:
        s (str): 対象の文字列
        default (int): 変換できない場合に返す値

    Returns:
        int: 抜き出した数字の整数値、またはdefault値
    """
    try:
        # 正規表現で数字部分を抽出
        match = re.search(r'\d+', s)
        if match:
            return int(match.group())
        else:
            return default
    except ValueError:
        return default

def extract_float(s: str, default: float = 0.0) -> float:
    """
    文字列から数字だけを抜き出してfloatに変換する関数。
    変換できない場合はdefaultの値を返す。

    Args:
        s (str): 対象の文字列
        default (float): 変換できない場合に返す値

    Returns:
        float: 抜き出した数字の浮動小数点数値、またはdefault値
    """
    try:
        # 正規表現で浮動小数点数または整数部分を抽出
        match = re.search(r'\d+(\.\d+)?', s)
        if match:
            return float(match.group())
        else:
            return default
    except ValueError:
        return default


if __name__=='__main__':
    
    data_list = [t.strip() for t in data_species_property.split("\n")]
    data_list = [t for t in data_list if t]

    #remove symbol rows
    

    # split with category
    keys = (EVERGREEN_TEXT,DICIDOUS_TEXT,BROADLEAF_TEXT,CONIFERS_TEXT)
    pat_string = "{}".format("|".join(t for t in keys))

    pat = re.compile(pat_string)
    key_indices = []

    for i,row in enumerate(data_list):
        if pat.search(row):
            # check category contains is_evergreen and is_broadleaf
            if not (
                (EVERGREEN_TEXT in row or DICIDOUS_TEXT in row)
            and (BROADLEAF_TEXT in row or CONIFERS_TEXT in row)
            ):
                raise Exception(f"Can't recognise category property from row:{row}")
            key_indices.append(i)
    
    if not key_indices: raise Exception("No category is found")
    
    key_indices.append(-1)
    categorized_data = {}
    for si,ei in zip(key_indices[:-1],key_indices[1:]):
        categorized_data[data_list[si]] = data_list[si+1:ei]


    pat_for_symbol = re.compile(r"[a-zA-Z\s\.\,]+")
    # make species dictionary whose species is is_evergreen and is_conifers
    speacies_database_list = []
    for category,speacies_and_symbol_list in categorized_data.items():
        is_evergreen = "TRUE" if EVERGREEN_TEXT in category else "FALSE"
        is_conifers = "TRUE" if CONIFERS_TEXT in category else "FALSE"

        symbol_key_indices = []
        for i,row in enumerate(speacies_and_symbol_list):
            if not pat_for_symbol.match(row): # not symbol row == speacies row
                symbol_key_indices.append(i)
    
        if not symbol_key_indices: raise Exception("No symbol is found")
    
        symbol_key_indices.append(-1)
        symbol_splitted_data = {}
        print(symbol_key_indices)
        for si,ei in zip(symbol_key_indices[:-1],symbol_key_indices[1:]):
            speacies_row = speacies_and_symbol_list[si]
            speacies_info = speacies_row.split('\t')
            print(speacies_row)

            speacies = str(speacies_info[SPECIES_INDEX])
            max_height = str(extract_int(speacies_info[MAXHEIGHT_INDEX]))
            shade_tolerance = str(PARAM_DICT[speacies_info[SHADETOLERANCE_INDEX]])
            wind_tolerance = str(PARAM_DICT[speacies_info[WINDTOLERANCE_INDEX]])
            shape_type = str(speacies_info[SHAPETYPE_INDEX])
            root_type = str(speacies_info[ROOTTYPE_INDEX])
            growing_speed = str(speacies_info[GROWING_SPEED_INDEX])
            # supplement = get_element_by_index(speacies_info,SUPPLEMENT_INDEX,"")

            speacies_database_row = [speacies,max_height,shade_tolerance,wind_tolerance,shape_type,root_type,growing_speed,is_evergreen,is_conifers]
            speacies_database_list.append(','.join(speacies_database_row))


            # for symbol_row in speacies_and_symbol_list[si+1:ei]:
            #     symbol_info = symbol_row.split('\t')

            #     symbol = symbol_info[SYMBOL_INDEX]
            #     height = extract_float(symbol_info[HEIGHT_INDEX])
            #     trunk = extract_float(symbol_info[TRUNK_INDEX])
            #     canopy_d = extract_float(symbol_info[CANOPYD_INDEX])



            #symbol_splitted_data[speacies_and_symbol_list[si]] = speacies_and_symbol_list[si+1:ei]

    path = Path(r".\speacies_database_text.csv").absolute()
    path.write_text("\n".join(speacies_database_list),encoding='shift_jis')
    # # make species properties list by category_dict
    # speacies_list = [t.strip() for t in data_species.split("\n")]
    # speacies_list = [t for t in speacies_list if t]
    # print('is_evergreen------------------------')
    # print('\n'.join("TRUE" if category_dict[s][0] else "FALSE" for s in speacies_list))

    
    # print('\n\nis_conifers------------------------')
    # print('\n'.join("TRUE" if category_dict[s][1] else "FALSE" for s in speacies_list))